<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimator Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        header {
            text-align: center;
            padding: 20px 0;
        }

        header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            color: #aaa;
            margin-top: 10px;
            font-size: 1.1em;
        }

        /* Current Category Banner */
        .current-category-banner {
            text-align: center;
            padding: 12px 20px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .current-category-banner span {
            color: #aaa;
        }

        .current-category-banner .category-name {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 25px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            border-radius: 25px;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        /* Form Styles */
        .form-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .form-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: 2px solid #667eea;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group select option {
            background: #1a1a2e;
            color: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Category Tags */
        .category-tag {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 8px;
            background: rgba(102, 126, 234, 0.3);
            color: #667eea;
        }

        /* Import Section */
        .import-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .import-section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .import-info {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .import-info code {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-right: 10px;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .paste-area {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.03);
            color: white;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
            margin-bottom: 15px;
        }

        .paste-area:focus {
            outline: none;
            border-color: #667eea;
        }

        .paste-area::placeholder {
            color: #666;
        }

        /* Categories Tab */
        .categories-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .categories-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .category-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .category-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .category-card:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.2);
        }

        .category-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .category-card.selected::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .category-card .cat-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .category-card .cat-count {
            color: #888;
            font-size: 0.9em;
        }

        .category-card .cat-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .category-card .cat-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .category-card .select-btn {
            background: rgba(102, 126, 234, 0.3);
            color: #667eea;
        }

        .category-card .select-btn:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        .category-card.selected .select-btn {
            background: #667eea;
            color: white;
        }

        .category-card .delete-btn {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .category-card .delete-btn:hover {
            background: rgba(244, 67, 54, 0.4);
        }

        .category-card .clear-btn {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .category-card .clear-btn:hover {
            background: rgba(255, 152, 0, 0.4);
        }

        /* Questions List */
        .questions-list-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .questions-list-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .question-count {
            font-size: 0.8em;
            color: #aaa;
            font-weight: normal;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-controls select {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9em;
        }

        .filter-controls select option {
            background: #1a1a2e;
        }

        .questions-list {
            list-style: none;
        }

        .question-item {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .question-item:hover {
            background: rgba(255,255,255,0.06);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .question-text {
            font-size: 1.1em;
            font-weight: 600;
            color: #fff;
            flex: 1;
        }

        .question-actions {
            display: flex;
            gap: 8px;
        }

        .question-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .question-actions button:hover {
            opacity: 1;
        }

        .question-actions .edit-btn { color: #667eea; }
        .question-actions .delete-btn { color: #f44336; }

        .question-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .question-answer {
            color: #4caf50;
            font-size: 0.95em;
        }

        .question-stats {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .question-multiplier {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(102, 126, 234, 0.15);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .question-multiplier .mult-label {
            color: #888;
        }

        .question-multiplier .mult-value {
            color: #667eea;
            font-weight: bold;
        }

        .question-multiplier input {
            width: 50px;
            padding: 2px 5px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: #667eea;
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
        }

        .question-multiplier input:focus {
            outline: none;
            border-color: #667eea;
        }

        .question-avg {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 152, 0, 0.15);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .question-avg .avg-label {
            color: #888;
        }

        .question-avg .avg-value {
            color: #ff9800;
            font-weight: bold;
        }

        .question-avg .avg-count {
            color: #666;
            font-size: 0.9em;
        }

        /* True Average Display */
        .true-average-display {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 10px;
            padding: 12px 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .true-avg-label {
            color: #aaa;
            font-size: 0.95em;
        }

        .true-avg-value {
            color: #4caf50;
            font-weight: bold;
            font-size: 1.2em;
        }

        .true-avg-info {
            color: #666;
            font-size: 0.85em;
        }

        /* Operator Login System */
        .admin-only {
            display: none !important;
        }

        body.operator-mode .admin-only {
            display: flex !important;
        }

        body.operator-mode .admin-only-block {
            display: block !important;
        }

        .admin-only-block {
            display: none !important;
        }

        .login-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: #888;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
        }

        .login-btn:hover {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }

        body.operator-mode .login-btn {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            color: #667eea;
        }

        /* Login Modal */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .login-modal.show {
            display: flex;
        }

        .login-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 350px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .login-modal-content h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .login-modal-content input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .login-modal-content input:focus {
            outline: 2px solid #667eea;
        }

        .login-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .login-error {
            color: #f44336;
            font-size: 0.9em;
            margin-bottom: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Report System */
        .report-btn {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .report-btn:hover {
            background: rgba(255, 152, 0, 0.4);
        }

        .report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .report-modal.show {
            display: flex;
        }

        .report-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .report-modal-content h3 {
            color: #ff9800;
            margin-bottom: 10px;
        }

        .report-modal-content .report-question-text {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .report-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .report-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .report-option:hover {
            background: rgba(255,255,255,0.1);
        }

        .report-option.selected {
            border-color: #ff9800;
            background: rgba(255, 152, 0, 0.1);
        }

        .report-option input[type="checkbox"] {
            display: none;
        }

        .report-option .report-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .report-option.selected .report-checkbox {
            background: #ff9800;
            border-color: #ff9800;
        }

        .report-option.selected .report-checkbox::after {
            content: '✓';
            color: white;
            font-size: 12px;
        }

        .report-option .report-label {
            color: #fff;
            font-size: 0.95em;
        }

        .report-comment {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.95em;
            resize: vertical;
            margin-bottom: 20px;
        }

        .report-comment:focus {
            outline: 2px solid #ff9800;
        }

        .report-comment::placeholder {
            color: #666;
        }

        .report-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Question Report Indicator */
        .question-reported {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 152, 0, 0.15);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            color: #ff9800;
            cursor: pointer;
        }

        .question-reported:hover {
            background: rgba(255, 152, 0, 0.25);
        }

        /* Sorting Controls */
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .sort-controls label {
            color: #aaa;
        }

        .sort-controls select {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9em;
            cursor: pointer;
        }

        .sort-controls select option {
            background: #1a1a2e;
        }

        /* Test Tab */
        .test-intro {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .test-intro h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .test-intro p {
            color: #aaa;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .name-input-container {
            max-width: 400px;
            margin: 0 auto 20px;
        }

        .name-input-container input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.2em;
            text-align: center;
        }

        .name-input-container input:focus {
            outline: 2px solid #667eea;
        }

        /* Category Selection */
        .category-selection {
            max-width: 500px;
            margin: 0 auto 25px;
            text-align: left;
        }

        .category-selection h3 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
        }

        .category-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .category-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .category-checkbox:hover {
            background: rgba(255,255,255,0.1);
        }

        .category-checkbox.selected {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .category-checkbox input {
            display: none;
        }

        .category-checkbox .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .category-checkbox.selected .checkmark {
            background: #667eea;
            border-color: #667eea;
        }

        .category-checkbox.selected .checkmark::after {
            content: '✓';
            color: white;
            font-size: 12px;
        }

        .category-checkbox .cat-label {
            color: #fff;
        }

        .category-checkbox .cat-count {
            color: #888;
            font-size: 0.85em;
        }

        /* Test Length Selection */
        .test-length-selection {
            max-width: 400px;
            margin: 0 auto 25px;
        }

        .test-length-selection h3 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.1em;
        }

        .test-length-options {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .test-length-option {
            padding: 15px 25px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid rgba(255,255,255,0.1);
            text-align: center;
            min-width: 90px;
        }

        .test-length-option:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .test-length-option.selected {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .test-length-option .length-number {
            display: block;
            font-size: 1.8em;
            font-weight: bold;
            color: #fff;
        }

        .test-length-option.selected .length-number {
            color: #667eea;
        }

        .test-length-option .length-label {
            display: block;
            font-size: 0.85em;
            color: #888;
            margin-top: 5px;
        }

        .test-question-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 40px;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }

        .test-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-wrap: wrap;
            gap: 10px;
        }

        .test-progress .question-num {
            color: #667eea;
            font-weight: bold;
            font-size: 1.1em;
        }

        .test-progress .total-score {
            color: #aaa;
        }

        .test-categories {
            width: 100%;
            text-align: center;
            color: #888;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .current-question {
            text-align: center;
        }

        .current-question h3 {
            font-size: 1.6em;
            margin-bottom: 30px;
            color: #fff;
            line-height: 1.4;
        }

        .answer-input-container {
            max-width: 300px;
            margin: 0 auto 30px;
        }

        .answer-input-container input {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.5em;
            text-align: center;
        }

        .answer-input-container input:focus {
            outline: 2px solid #667eea;
        }

        .result-display {
            display: none;
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 15px;
            margin-top: 20px;
        }

        .result-display.show {
            display: block;
        }

        .result-display .correct-answer {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .result-display .correct-answer span {
            color: #4caf50;
            font-weight: bold;
        }

        .result-display .points-earned {
            font-size: 1.2em;
            color: #ff9800;
            margin-bottom: 15px;
        }

        .result-display .points-earned.good {
            color: #4caf50;
        }

        .result-display .points-earned.bad {
            color: #f44336;
        }

        /* Final Results */
        .final-results {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }

        .final-results h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .final-score {
            font-size: 4em;
            font-weight: bold;
            background: linear-gradient(90deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .final-score-label {
            color: #aaa;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .final-categories {
            color: #888;
            font-size: 0.95em;
            margin-bottom: 30px;
        }

        .score-breakdown {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }

        .score-breakdown h3 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-question {
            flex: 1;
            color: #aaa;
            font-size: 0.9em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 15px;
        }

        .breakdown-points {
            font-weight: bold;
        }

        .breakdown-points.good { color: #4caf50; }
        .breakdown-points.medium { color: #ff9800; }
        .breakdown-points.bad { color: #f44336; }

        /* Records Tab */
        .records-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .records-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8em;
        }

        .records-filter {
            margin-bottom: 20px;
            text-align: center;
        }

        .records-filter select {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1em;
            cursor: pointer;
        }

        .records-filter select option {
            background: #1a1a2e;
        }

        .leaderboard {
            list-style: none;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .leaderboard-item.gold {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .leaderboard-item.silver {
            border-color: #c0c0c0;
            background: rgba(192, 192, 192, 0.1);
        }

        .leaderboard-item.bronze {
            border-color: #cd7f32;
            background: rgba(205, 127, 50, 0.1);
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .rank.gold { color: #ffd700; }
        .rank.silver { color: #c0c0c0; }
        .rank.bronze { color: #cd7f32; }

        .leaderboard-info {
            flex: 1;
            margin-left: 15px;
        }

        .leaderboard-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #fff;
        }

        .leaderboard-date {
            color: #888;
            font-size: 0.85em;
        }

        .leaderboard-categories {
            color: #667eea;
            font-size: 0.8em;
            margin-top: 3px;
        }

        .leaderboard-score {
            font-size: 1.4em;
            font-weight: bold;
            color: #4caf50;
        }

        .no-records {
            text-align: center;
            padding: 50px;
            color: #aaa;
        }

        .no-records h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            transform: translateX(150%);
            transition: transform 0.3s;
            z-index: 3000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #4caf50, #45a049);
        }

        .notification.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .notification.info {
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }

        .no-questions-message {
            text-align: center;
            padding: 50px;
            color: #aaa;
        }

        .no-questions-message h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .no-categories-message {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }

        .no-categories-message h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        /* Info Section */
        .info-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .info-section h2 {
            color: #667eea;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8em;
        }

        .info-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .info-block {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .info-block:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-block h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .info-block p {
            color: #ccc;
            line-height: 1.7;
            margin-bottom: 15px;
        }

        .info-block ol, .info-block ul {
            color: #ccc;
            line-height: 1.8;
            padding-left: 25px;
        }

        .info-block li {
            margin-bottom: 10px;
        }

        .formula-box {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .formula-box h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .formula {
            font-size: 1.4em;
            font-family: 'Times New Roman', serif;
            color: #fff;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            display: inline-block;
        }

        .formula sup {
            font-size: 0.7em;
        }

        .formula-legend {
            color: #aaa;
            font-size: 0.95em;
            margin-top: 15px;
            margin-bottom: 0;
        }

        .scoring-examples {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .scoring-examples h4 {
            color: #fff;
            margin-bottom: 15px;
        }

        .scoring-examples ul {
            list-style: none;
            padding-left: 0;
        }

        .scoring-examples li {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }

        .score-good {
            color: #4caf50;
            font-weight: bold;
            min-width: 120px;
        }

        .score-medium {
            color: #ff9800;
            font-weight: bold;
            min-width: 120px;
        }

        .score-bad {
            color: #f44336;
            font-weight: bold;
            min-width: 120px;
        }

        /* Compare Test (Which is Bigger?) Styles */
        .compare-intro {
            text-align: center;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 40px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .compare-intro h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .compare-intro p {
            color: #aaa;
            margin-bottom: 10px;
        }

        .compare-question-container {
            display: none;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .compare-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .compare-option {
            width: 100%;
            max-width: 600px;
            padding: 25px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .compare-option:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateX(5px);
        }

        .compare-option.selected {
            pointer-events: none;
        }

        .compare-option.correct {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4caf50;
        }

        .compare-option.incorrect {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }

        .compare-option.disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        .compare-letter {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            background: rgba(102, 126, 234, 0.2);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .compare-option-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .compare-question-text {
            font-size: 1.1em;
            color: #fff;
        }

        .compare-inline-answer {
            display: none;
            font-size: 1.2em;
            font-weight: bold;
            color: #4caf50;
            padding: 5px 12px;
            background: rgba(76, 175, 80, 0.15);
            border-radius: 8px;
            width: fit-content;
        }

        .compare-inline-answer.show {
            display: inline-block;
        }

        .compare-vs {
            font-size: 1.5em;
            font-weight: bold;
            color: #ff9800;
            padding: 10px 0;
        }

        .compare-result {
            display: none;
            text-align: center;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .compare-result-text {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .compare-result-text.correct {
            color: #4caf50;
        }

        .compare-result-text.incorrect {
            color: #f44336;
        }

        .compare-answers {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 20px;
        }

        .compare-answer-item {
            background: rgba(255,255,255,0.05);
            padding: 15px 25px;
            border-radius: 10px;
        }

        .compare-answer-label {
            color: #aaa;
            margin-right: 10px;
        }

        .compare-answer-value {
            color: #fff;
            font-weight: bold;
            font-size: 1.1em;
        }

        .compare-report-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .compare-percentage {
            font-size: 1.3em;
            color: #667eea;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        #compare-final-results {
            display: none;
        }

        /* Test Mode Selection */
        .test-mode-selection {
            text-align: center;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 40px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .test-mode-selection h2 {
            color: #667eea;
            margin-bottom: 30px;
        }

        .test-mode-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .test-mode-option {
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            width: 250px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .test-mode-option:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-3px);
        }

        .test-mode-option.selected {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .mode-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .mode-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #fff;
            margin-bottom: 10px;
        }

        .mode-desc {
            font-size: 0.9em;
            color: #aaa;
        }

        .test-intro-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* Records Type Selector */
        .records-type-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .records-type-btn {
            padding: 12px 30px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            border-radius: 25px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .records-type-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .records-type-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .tab-btn {
                padding: 10px 15px;
                font-size: 0.85em;
            }

            .test-intro, .test-question-container, .final-results {
                padding: 25px;
            }

            .current-question h3 {
                font-size: 1.3em;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .category-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Estimator Quiz</h1>
            <p>Test your estimation skills with numerical questions</p>
        </header>

        <div class="current-category-banner admin-only" id="current-category-banner">
            <span>Adding questions to: </span>
            <span class="category-name" id="current-category-name">Uncategorized</span>
        </div>

        <div class="tabs">
            <button class="tab-btn" onclick="switchTab('info')">Info</button>
            <button class="tab-btn admin-only" onclick="switchTab('categories')">Categories</button>
            <button class="tab-btn admin-only" onclick="switchTab('questions')">Questions</button>
            <button class="tab-btn active" onclick="switchTab('test')">Test</button>
            <button class="tab-btn" onclick="switchTab('records')">Records</button>
        </div>

        <!-- Info Tab -->
        <div id="info-tab" class="tab-content">
            <div class="info-section">
                <h2>How It Works</h2>
                <div class="info-content">
                    <div class="info-block">
                        <h3>About Estimator Quiz</h3>
                        <p>Estimator Quiz tests your ability to estimate numerical answers to various questions. How many bones are in the human body? What's the population of Tokyo? How far is the moon from Earth? Your goal is to get as close to the correct answer as possible.</p>
                    </div>

                    <div class="info-block">
                        <h3>Getting Started</h3>
                        <ol>
                            <li><strong>Add Questions:</strong> Go to the Questions tab to add your own questions with numerical answers, or import them from a spreadsheet/CSV file.</li>
                            <li><strong>Organize by Category:</strong> Use the Categories tab to create categories (like "Science", "Geography", "History") and organize your questions.</li>
                            <li><strong>Take the Test:</strong> Enter your name, optionally select specific categories, and answer up to 20 randomly selected questions.</li>
                            <li><strong>View Records:</strong> Compare your scores with others on the leaderboard, filtered by category combination.</li>
                        </ol>
                    </div>

                    <div class="info-block">
                        <h3>Scoring System</h3>
                        <p>The scoring uses a logarithmic scale that rewards accuracy while being forgiving of order-of-magnitude errors. You can score between <strong>0 and 1000 points</strong> per question.</p>

                        <div class="formula-box">
                            <h4>The Formula</h4>
                            <div class="formula">Score = 1000 × e<sup>−(ln(x/U))² / B²</sup></div>
                            <p class="formula-legend">
                                Where: <strong>x</strong> = your answer, <strong>U</strong> = correct answer, <strong>B</strong> = question multiplier
                            </p>
                        </div>

                        <div class="scoring-examples">
                            <h4>What This Means</h4>
                            <ul>
                                <li><span class="score-good">1000 points</span> - Perfect answer (x = U)</li>
                                <li><span class="score-good">~800+ points</span> - Within ~25% of correct answer</li>
                                <li><span class="score-medium">~400-800 points</span> - Within same order of magnitude</li>
                                <li><span class="score-bad">&lt;400 points</span> - Off by more than 2x</li>
                                <li><span class="score-bad">~0 points</span> - Off by 10x or more</li>
                            </ul>
                        </div>

                        <p>This logarithmic scoring means that being off by a factor of 2 (e.g., guessing 100 when the answer is 200) is treated the same whether the correct answer is 200 or 2 million. It's about the <em>ratio</em>, not the absolute difference.</p>
                    </div>

                    <div class="info-block">
                        <h3>Adaptive Difficulty (Question Multiplier)</h3>
                        <p>Each question has a <strong>multiplier (B)</strong> that adjusts its difficulty:</p>
                        <ul>
                            <li><strong>Higher B</strong> = More forgiving scoring (easier to get points)</li>
                            <li><strong>Lower B</strong> = Stricter scoring (harder to get points)</li>
                            <li><strong>Default B = 1</strong> - Standard difficulty</li>
                        </ul>
                        <p>The system automatically adjusts multipliers to balance question difficulty:</p>
                        <ul>
                            <li>After a question is answered <strong>5 times</strong>, its average score is compared to the overall "True Average"</li>
                            <li>If players score <strong>higher than average</strong> on a question, its multiplier decreases (making it harder)</li>
                            <li>If players score <strong>lower than average</strong>, its multiplier increases (making it easier)</li>
                            <li>This helps ensure all questions contribute similarly to overall scores</li>
                        </ul>
                        <p>You can manually adjust any question's multiplier in the Questions tab. Manual changes reset the question's average tracking.</p>
                    </div>

                    <div class="info-block">
                        <h3>Tips for High Scores</h3>
                        <ul>
                            <li>Think in orders of magnitude - is the answer in the hundreds, thousands, or millions?</li>
                            <li>Use reference points you know to estimate unknowns</li>
                            <li>Don't leave questions blank - even a rough guess can earn some points!</li>
                            <li>Practice with specific categories to improve in areas you're weak</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div id="categories-tab" class="tab-content">
            <div class="categories-section">
                <h2>Create New Category</h2>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="new-category" placeholder="Category name (e.g., 'Science', 'Geography')" style="flex: 1; min-width: 250px; padding: 12px; border: none; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 1em;" onkeypress="if(event.key==='Enter')addCategory()">
                    <button class="btn btn-primary" onclick="addCategory()">Create Category</button>
                </div>
            </div>

            <div class="categories-section">
                <h2>Your Categories</h2>
                <p style="color: #aaa; margin-bottom: 15px;">Select a category to add questions to it. New questions will automatically be added to the selected category.</p>
                <div class="category-cards" id="category-cards">
                    <!-- Categories will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Questions Tab -->
        <div id="questions-tab" class="tab-content active">
            <!-- Import Section -->
            <div class="import-section">
                <h2>Import Questions from Table/CSV</h2>
                <div class="import-info">
                    <p>Paste data from a spreadsheet or CSV file. Format: <code>Question, Answer</code> or <code>Question, Answer, Category</code></p>
                    <p>Supports comma, tab, or semicolon separators. One question per line.</p>
                    <p><strong>Note:</strong> If no category is specified in the import, questions go to the currently selected category.</p>
                </div>
                <textarea class="paste-area" id="import-paste" placeholder="Paste your data here...
Example:
How many bones in the human body?, 206
Distance from Earth to Moon in miles?, 238900
Population of Tokyo?, 13960000"></textarea>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <div class="file-input-wrapper">
                        <button class="btn btn-secondary">Upload CSV File</button>
                        <input type="file" id="csv-upload" accept=".csv,.txt" onchange="handleFileUpload(event)">
                    </div>
                    <button class="btn btn-primary" onclick="importFromPaste()">Import Pasted Data</button>
                </div>
            </div>

            <!-- Add Question Form -->
            <div class="form-section">
                <h2 id="question-form-title">Add New Question</h2>
                <div class="form-group">
                    <label for="question-text">Question *</label>
                    <textarea id="question-text" placeholder="e.g., 'How many miles is it from New York to Los Angeles?'"></textarea>
                </div>
                <div class="form-group">
                    <label for="question-answer">Correct Answer (number) *</label>
                    <input type="number" id="question-answer" placeholder="e.g., 2790" step="any">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="question-submit-btn" onclick="addOrUpdateQuestion()">Add Question</button>
                    <button class="btn btn-secondary" id="question-cancel-btn" onclick="cancelQuestionEdit()" style="display: none;">Cancel</button>
                </div>
            </div>

            <!-- Questions List -->
            <div class="questions-list-section">
                <h2>
                    Your Questions
                    <span class="question-count" id="question-count">0 questions</span>
                </h2>
                <div class="true-average-display" id="true-average-display">
                    <span class="true-avg-label">True Average:</span>
                    <span class="true-avg-value" id="true-avg-value">--</span>
                    <span class="true-avg-info">(avg points per question across all answers)</span>
                </div>
                <div class="filter-controls">
                    <label style="color: #aaa;">Filter by category:</label>
                    <select id="questions-filter" onchange="renderQuestions()">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select id="questions-sort" onchange="renderQuestions()">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="multiplier-high">Multiplier (High to Low)</option>
                        <option value="multiplier-low">Multiplier (Low to High)</option>
                        <option value="avg-high">Avg Score (High to Low)</option>
                        <option value="avg-low">Avg Score (Low to High)</option>
                        <option value="reported">Reported First</option>
                        <option value="most-reports">Most Reports</option>
                    </select>
                </div>
                <ul class="questions-list" id="questions-list">
                    <!-- Questions will be rendered here -->
                </ul>
            </div>
        </div>

        <!-- Test Tab -->
        <div id="test-tab" class="tab-content">
            <!-- Test Mode Selection -->
            <div class="test-mode-selection" id="test-mode-selection">
                <h2>Choose Your Test Mode</h2>
                <div class="test-mode-options">
                    <div class="test-mode-option selected" onclick="selectTestMode('estimation', this)">
                        <div class="mode-icon">🎯</div>
                        <div class="mode-name">Estimation</div>
                        <div class="mode-desc">Enter your best guess for numerical questions</div>
                    </div>
                    <div class="test-mode-option" onclick="selectTestMode('compare', this)">
                        <div class="mode-icon">⚖️</div>
                        <div class="mode-name">Which is Bigger?</div>
                        <div class="mode-desc">Choose which of two questions has the larger answer</div>
                    </div>
                </div>
            </div>

            <!-- Estimation Test Intro -->
            <div class="test-intro" id="test-intro" style="display: none;">
                <h2>Estimation Test</h2>
                <p>You'll be asked questions that require numerical answers. Your score is based on how close your estimates are to the correct answers using a logarithmic scale.</p>
                <p style="color: #4caf50; margin-bottom: 20px;"><strong>Higher score = Better! (Max 1000 per question)</strong></p>

                <div class="name-input-container">
                    <input type="text" id="player-name" placeholder="Enter your name">
                </div>

                <div class="test-length-selection">
                    <h3>Test Length</h3>
                    <div class="test-length-options">
                        <div class="test-length-option" onclick="selectTestLength(10, this)">
                            <span class="length-number">10</span>
                            <span class="length-label">Questions</span>
                        </div>
                        <div class="test-length-option selected" onclick="selectTestLength(20, this)">
                            <span class="length-number">20</span>
                            <span class="length-label">Questions</span>
                        </div>
                        <div class="test-length-option" onclick="selectTestLength(30, this)">
                            <span class="length-number">30</span>
                            <span class="length-label">Questions</span>
                        </div>
                    </div>
                </div>

                <div class="category-selection" id="category-selection">
                    <h3>Select Category</h3>
                    <div class="category-checkboxes" id="category-checkboxes">
                        <!-- Category checkboxes will be rendered here -->
                    </div>
                </div>

                <div class="test-intro-buttons">
                    <button class="btn btn-secondary" onclick="backToModeSelection()">Back</button>
                    <button class="btn btn-primary" onclick="startTest()" style="font-size: 1.1em; padding: 12px 35px;">Start Test</button>
                </div>
            </div>

            <!-- Compare Test Intro -->
            <div class="compare-intro" id="compare-intro" style="display: none;">
                <h2>Which is Bigger?</h2>
                <p>You'll be shown two questions. Choose the one with the larger numerical answer. Questions are paired so they have similar answer ranges - this won't be easy!</p>
                <p style="color: #4caf50; margin-bottom: 20px;"><strong>Score: +1 for each correct answer</strong></p>

                <div class="name-input-container">
                    <input type="text" id="compare-player-name" placeholder="Enter your name">
                </div>

                <div class="test-length-selection">
                    <h3>Test Length</h3>
                    <div class="test-length-options">
                        <div class="test-length-option" onclick="selectCompareLength(10, this)">
                            <span class="length-number">10</span>
                            <span class="length-label">Questions</span>
                        </div>
                        <div class="test-length-option selected" onclick="selectCompareLength(20, this)">
                            <span class="length-number">20</span>
                            <span class="length-label">Questions</span>
                        </div>
                        <div class="test-length-option" onclick="selectCompareLength(30, this)">
                            <span class="length-number">30</span>
                            <span class="length-label">Questions</span>
                        </div>
                    </div>
                </div>

                <div class="category-selection" id="compare-category-selection">
                    <h3>Select Category</h3>
                    <div class="category-checkboxes" id="compare-category-checkboxes">
                        <!-- Category checkboxes will be rendered here -->
                    </div>
                </div>

                <div class="test-intro-buttons">
                    <button class="btn btn-secondary" onclick="backToModeSelection()">Back</button>
                    <button class="btn btn-primary" onclick="startCompareTest()" style="font-size: 1.1em; padding: 12px 35px;">Start Test</button>
                </div>
            </div>

            <div class="test-question-container" id="test-question-container">
                <div class="test-progress">
                    <span class="question-num" id="question-num">Question 1 of 20</span>
                    <span class="total-score">Total Points: <span id="running-total">0</span></span>
                    <div class="test-categories" id="test-categories"></div>
                </div>
                <div class="current-question">
                    <h3 id="current-question-text">Loading question...</h3>
                    <div class="answer-input-container">
                        <input type="number" id="test-answer" placeholder="Your answer" step="any" onkeypress="if(event.key==='Enter')submitAnswer()">
                    </div>
                    <button class="btn btn-primary" id="submit-answer-btn" onclick="submitAnswer()">Submit Answer</button>
                    <button class="btn btn-success" id="next-question-btn" onclick="nextQuestion()" style="display: none;">Next Question</button>
                </div>
                <div class="result-display" id="result-display">
                    <div class="correct-answer">Correct Answer: <span id="correct-answer-value">0</span></div>
                    <div class="points-earned" id="points-earned">+0 points</div>
                    <button class="report-btn" onclick="openReportModal()">Report Question</button>
                </div>
            </div>

            <div class="final-results" id="final-results">
                <h2>Quiz Complete!</h2>
                <div class="final-score" id="final-score">0</div>
                <div class="final-score-label">Total Points (Higher is Better)</div>
                <div class="final-categories" id="final-categories"></div>
                <div class="score-breakdown" id="score-breakdown">
                    <h3>Question Breakdown</h3>
                    <!-- Breakdown items will be added here -->
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="resetTest()">Try Again</button>
                    <button class="btn btn-secondary" onclick="switchTab('records')">View Records</button>
                </div>
            </div>

            <!-- Compare Question Container (inside Test tab) -->
            <div class="compare-question-container" id="compare-question-container">
                <div class="test-progress">
                    <span class="question-num" id="compare-question-num">Question 1 of 20</span>
                    <span class="total-score">Score: <span id="compare-running-total">0</span> / <span id="compare-total-questions">20</span></span>
                    <div class="test-categories" id="compare-test-categories"></div>
                </div>
                <h3 style="text-align: center; color: #aaa; margin-bottom: 20px;">Which has the larger answer?</h3>
                <div class="compare-options">
                    <div class="compare-option" id="compare-option-a" onclick="submitCompareAnswer('A')">
                        <span class="compare-letter">A</span>
                        <div class="compare-option-content">
                            <span class="compare-question-text" id="compare-text-a">Loading...</span>
                            <span class="compare-inline-answer" id="compare-answer-a"></span>
                        </div>
                    </div>
                    <div class="compare-vs">VS</div>
                    <div class="compare-option" id="compare-option-b" onclick="submitCompareAnswer('B')">
                        <span class="compare-letter">B</span>
                        <div class="compare-option-content">
                            <span class="compare-question-text" id="compare-text-b">Loading...</span>
                            <span class="compare-inline-answer" id="compare-answer-b"></span>
                        </div>
                    </div>
                </div>
                <div class="compare-result" id="compare-result">
                    <div class="compare-result-text" id="compare-result-text">Correct!</div>
                    <div class="compare-report-buttons">
                        <button class="report-btn" onclick="openCompareReportModal('A')">Report Question A</button>
                        <button class="report-btn" onclick="openCompareReportModal('B')">Report Question B</button>
                    </div>
                    <button class="btn btn-success" id="compare-next-btn" onclick="nextCompareQuestion()">Next Question</button>
                </div>
            </div>

            <!-- Compare Final Results (inside Test tab) -->
            <div class="final-results" id="compare-final-results">
                <h2>Quiz Complete!</h2>
                <div class="final-score" id="compare-final-score">0 / 20</div>
                <div class="final-score-label">Correct Answers</div>
                <div class="compare-percentage" id="compare-percentage">0%</div>
                <div class="final-categories" id="compare-final-categories"></div>
                <div class="score-breakdown" id="compare-score-breakdown">
                    <h3>Question Breakdown</h3>
                    <!-- Breakdown items will be added here -->
                </div>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-primary" onclick="resetCompareTest()">Try Again</button>
                    <button class="btn btn-secondary" onclick="switchTab('records')">View Records</button>
                </div>
            </div>
        </div>

        <!-- Records Tab -->
        <div id="records-tab" class="tab-content">
            <!-- Records Type Selector -->
            <div class="records-type-selector">
                <button class="records-type-btn active" onclick="switchRecordsType('estimation')">Estimation</button>
                <button class="records-type-btn" onclick="switchRecordsType('compare')">Which is Bigger?</button>
            </div>

            <!-- Estimation Records -->
            <div class="records-section" id="estimation-records-section">
                <h2>Estimation Leaderboard</h2>
                <div class="records-filter">
                    <select id="records-filter" onchange="renderRecords()">
                        <option value="">All Category Combinations</option>
                    </select>
                </div>
                <ul class="leaderboard" id="leaderboard">
                    <!-- Records will be rendered here -->
                </ul>
                <div class="admin-only" style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button class="btn btn-danger btn-small" onclick="resetAllRecords()">Reset All Records</button>
                </div>
            </div>

            <!-- Compare Records -->
            <div class="records-section" id="compare-records-section" style="display: none;">
                <h2>Which is Bigger? Leaderboard</h2>
                <div class="records-filter">
                    <select id="compare-records-filter" onchange="renderCompareRecords()">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <ul class="leaderboard" id="compare-leaderboard">
                    <!-- Records will be rendered here -->
                </ul>
                <div class="admin-only" style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button class="btn btn-danger btn-small" onclick="resetCompareRecords()">Reset All Records</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Login Button -->
    <button class="login-btn" id="login-btn" onclick="toggleLoginModal()">
        <span id="login-btn-text">Operator Login</span>
    </button>

    <!-- Login Modal -->
    <div class="login-modal" id="login-modal">
        <div class="login-modal-content">
            <h3>Operator Login</h3>
            <div class="login-error" id="login-error">Incorrect password</div>
            <input type="password" id="operator-password" placeholder="Enter operator password" onkeypress="if(event.key==='Enter')attemptLogin()">
            <div class="login-modal-buttons">
                <button class="btn btn-primary" onclick="attemptLogin()">Login</button>
                <button class="btn btn-secondary" onclick="closeLoginModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="report-modal" id="report-modal">
        <div class="report-modal-content">
            <h3>Report Question</h3>
            <div class="report-question-text" id="report-question-text"></div>
            <p style="color: #aaa; margin-bottom: 15px; font-size: 0.9em;">Select all that apply:</p>
            <div class="report-options" id="report-options">
                <div class="report-option" onclick="toggleReportOption(this)" data-reason="not-specific">
                    <div class="report-checkbox"></div>
                    <span class="report-label">Not specific</span>
                </div>
                <div class="report-option" onclick="toggleReportOption(this)" data-reason="too-niche">
                    <div class="report-checkbox"></div>
                    <span class="report-label">Too niche</span>
                </div>
                <div class="report-option" onclick="toggleReportOption(this)" data-reason="too-easy">
                    <div class="report-checkbox"></div>
                    <span class="report-label">Too easy</span>
                </div>
            </div>
            <textarea class="report-comment" id="report-comment" placeholder="Additional comments (optional)..."></textarea>
            <div class="report-modal-buttons">
                <button class="btn btn-secondary" onclick="closeReportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitReport()" style="background: #ff9800;">Submit Report</button>
            </div>
        </div>
    </div>

    <script>
        // ===== DATA STRUCTURES =====

        let questions = [];
        let categories = [];
        let records = [];
        let selectedCategory = ''; // Currently selected category for adding questions
        let editingQuestionId = null;

        // Test state
        let testState = {
            playerName: '',
            currentIndex: 0,
            shuffledQuestions: [],
            answers: [],
            totalScore: 0,
            isActive: false,
            selectedCategory: 'all'
        };

        // Track asked questions to prevent repeats until all have been answered
        let askedQuestionIds = [];

        // Selected test length (10, 20, or 30 questions)
        let selectedTestLength = 20;

        // True average tracking (average points per question across all answers)
        let trueAverageData = {
            totalPoints: 0,
            totalAnswers: 0
        };

        // Operator login state
        let isOperator = false;
        // IMPORTANT: Change this password to your own secret password!
        const OPERATOR_PASSWORD = 'admin123';

        // Report system state
        let currentReportQuestionId = null;

        // Compare test state (Which is Bigger?)
        let compareState = {
            playerName: '',
            currentIndex: 0,
            questionPairs: [], // Array of {questionA, questionB} objects
            answers: [], // Array of {questionA, questionB, userChoice, correct, answerA, answerB}
            correctCount: 0,
            isActive: false,
            selectedCategory: 'all'
        };

        let selectedCompareLength = 20;
        let compareRecords = [];

        // Fixed test categories
        const TEST_CATEGORIES = ['Industry', 'Science', 'History', 'Entertainment', 'Fine Arts'];

        // ===== OPERATOR LOGIN SYSTEM =====

        function toggleLoginModal() {
            if (isOperator) {
                // Already logged in - log out
                logoutOperator();
            } else {
                // Show login modal
                document.getElementById('login-modal').classList.add('show');
                document.getElementById('operator-password').value = '';
                document.getElementById('login-error').classList.remove('show');
                document.getElementById('operator-password').focus();
            }
        }

        function closeLoginModal() {
            document.getElementById('login-modal').classList.remove('show');
        }

        function attemptLogin() {
            const password = document.getElementById('operator-password').value;

            if (password === OPERATOR_PASSWORD) {
                isOperator = true;
                document.body.classList.add('operator-mode');
                document.getElementById('login-btn-text').textContent = 'Logout';
                closeLoginModal();
                localStorage.setItem('estimatorQuizOperator', 'true');
                showNotification('Logged in as operator', 'success');

                // Switch to Questions tab since it's now visible
                switchTab('questions');
            } else {
                document.getElementById('login-error').classList.add('show');
                document.getElementById('operator-password').value = '';
                document.getElementById('operator-password').focus();
            }
        }

        function logoutOperator() {
            isOperator = false;
            document.body.classList.remove('operator-mode');
            document.getElementById('login-btn-text').textContent = 'Operator Login';
            localStorage.removeItem('estimatorQuizOperator');
            showNotification('Logged out', 'info');

            // Switch to Test tab since admin tabs are now hidden
            switchTab('test');
        }

        function checkOperatorSession() {
            const saved = localStorage.getItem('estimatorQuizOperator');
            if (saved === 'true') {
                isOperator = true;
                document.body.classList.add('operator-mode');
                document.getElementById('login-btn-text').textContent = 'Logout';
            }
        }

        // ===== REPORT SYSTEM =====

        function openReportModal() {
            const question = testState.shuffledQuestions[testState.currentIndex];
            if (!question) return;

            currentReportQuestionId = question.id;
            document.getElementById('report-question-text').textContent = question.text;

            // Reset all options
            document.querySelectorAll('.report-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('report-comment').value = '';

            document.getElementById('report-modal').classList.add('show');
        }

        function closeReportModal() {
            document.getElementById('report-modal').classList.remove('show');
            currentReportQuestionId = null;
        }

        function toggleReportOption(element) {
            element.classList.toggle('selected');
        }

        function submitReport() {
            if (!currentReportQuestionId) return;

            const selectedReasons = [];
            document.querySelectorAll('.report-option.selected').forEach(opt => {
                selectedReasons.push(opt.getAttribute('data-reason'));
            });

            const comment = document.getElementById('report-comment').value.trim();

            if (selectedReasons.length === 0 && !comment) {
                showNotification('Please select at least one reason or add a comment', 'error');
                return;
            }

            // Find the question and add the report
            const question = questions.find(q => q.id === currentReportQuestionId);
            if (question) {
                if (!question.reports) {
                    question.reports = [];
                }

                question.reports.push({
                    id: Date.now().toString(),
                    reasons: selectedReasons,
                    comment: comment,
                    date: Date.now(),
                    playerName: testState.playerName
                });

                saveData();
                showNotification('Report submitted. Thank you for your feedback!', 'success');
            }

            closeReportModal();
        }

        function clearQuestionReports(questionId, event) {
            if (event) event.stopPropagation();

            const question = questions.find(q => q.id === questionId);
            if (!question || !question.reports || question.reports.length === 0) return;

            if (!confirm(`Clear all ${question.reports.length} report(s) for this question?`)) return;

            question.reports = [];
            saveData();
            renderQuestions();
            showNotification('Reports cleared', 'success');
        }

        function viewQuestionReports(questionId, event) {
            if (event) event.stopPropagation();

            const question = questions.find(q => q.id === questionId);
            if (!question || !question.reports || question.reports.length === 0) return;

            const reasonLabels = {
                'too-broad': 'Too broad / vague',
                'too-niche': 'Too niche / obscure',
                'not-specific': 'Not specific enough',
                'incorrect-answer': 'Answer seems incorrect',
                'confusing': 'Confusing wording'
            };

            let reportSummary = `Reports for: "${question.text}"\n\n`;

            question.reports.forEach((report, index) => {
                const date = new Date(report.date).toLocaleDateString();
                reportSummary += `--- Report ${index + 1} (${date}) ---\n`;
                reportSummary += `From: ${report.playerName || 'Anonymous'}\n`;
                if (report.reasons.length > 0) {
                    reportSummary += `Reasons: ${report.reasons.map(r => reasonLabels[r] || r).join(', ')}\n`;
                }
                if (report.comment) {
                    reportSummary += `Comment: ${report.comment}\n`;
                }
                reportSummary += '\n';
            });

            alert(reportSummary);
        }

        // ===== INITIALIZATION =====

        function init() {
            loadData();
            loadCompareRecords();
            checkOperatorSession();
            renderAll();
            renderCompareCategoryCheckboxes();
            updateCompareRecordsFilter();
            renderCompareRecords();
            updateCurrentCategoryBanner();

            // If not operator, make sure we're on a visible tab
            if (!isOperator) {
                switchTab('test');
            }
        }

        // ===== IMPORT FUNCTIONALITY =====

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('import-paste').value = e.target.result;
                showNotification('File loaded! Click "Import Pasted Data" to import.', 'info');
            };
            reader.readAsText(file);
        }

        function importFromPaste() {
            const pasteArea = document.getElementById('import-paste');
            const data = pasteArea.value.trim();

            if (!data) {
                showNotification('Please paste some data first', 'error');
                return;
            }

            const lines = data.split('\n').filter(line => line.trim());
            let imported = 0;
            let skipped = 0;

            for (const line of lines) {
                // Try different separators: tab, comma, semicolon
                let parts;
                if (line.includes('\t')) {
                    parts = line.split('\t');
                } else if (line.includes(';')) {
                    parts = line.split(';');
                } else {
                    parts = parseCSVLine(line);
                }

                parts = parts.map(p => p.trim());

                if (parts.length < 2) {
                    skipped++;
                    continue;
                }

                const questionText = parts[0];
                const answerText = parts[1];
                // Use specified category, or fall back to currently selected category
                const categoryText = parts[2] || selectedCategory;

                const answer = parseFloat(answerText.replace(/,/g, ''));

                if (!questionText || isNaN(answer)) {
                    skipped++;
                    continue;
                }

                // Add category if it doesn't exist and is specified
                if (categoryText && !categories.includes(categoryText)) {
                    categories.push(categoryText);
                }

                questions.push({
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    text: questionText,
                    answer: answer,
                    category: categoryText,
                    createdAt: Date.now(),
                    multiplier: 1,
                    avgPoints: 0,
                    avgCount: 0
                });

                imported++;
            }

            if (imported > 0) {
                saveData();
                renderAll();
                pasteArea.value = '';
                showNotification(`Imported ${imported} question${imported !== 1 ? 's' : ''}${skipped > 0 ? ` (${skipped} skipped)` : ''}`, 'success');
            } else {
                showNotification('No valid questions found. Check your format.', 'error');
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);

            return result;
        }

        // ===== CATEGORY MANAGEMENT =====

        function addCategory() {
            const input = document.getElementById('new-category');
            const name = input.value.trim();

            if (!name) {
                showNotification('Please enter a category name', 'error');
                return;
            }

            if (categories.includes(name)) {
                showNotification('Category already exists', 'error');
                return;
            }

            categories.push(name);
            selectedCategory = name; // Auto-select the new category
            input.value = '';
            saveData();
            renderAll();
            updateCurrentCategoryBanner();
            showNotification(`Category "${name}" created and selected!`, 'success');
        }

        function selectCategory(name) {
            selectedCategory = name;
            saveData();
            renderCategoryCards();
            updateCurrentCategoryBanner();
            showNotification(`Now adding questions to "${name || 'Uncategorized'}"`, 'info');
        }

        function deleteCategory(name, event) {
            event.stopPropagation(); // Prevent selecting when clicking delete

            const questionsInCategory = questions.filter(q => q.category === name).length;

            let message = `Delete category "${name}"?`;
            if (questionsInCategory > 0) {
                message += ` (${questionsInCategory} question${questionsInCategory !== 1 ? 's' : ''} will become uncategorized)`;
            }

            if (!confirm(message)) return;

            categories = categories.filter(c => c !== name);

            // Remove category from questions
            questions.forEach(q => {
                if (q.category === name) {
                    q.category = '';
                }
            });

            // If deleted category was selected, reset to uncategorized
            if (selectedCategory === name) {
                selectedCategory = '';
            }

            saveData();
            renderAll();
            updateCurrentCategoryBanner();
            showNotification(`Category "${name}" deleted`, 'info');
        }

        function clearCategoryQuestions(name, event) {
            event.stopPropagation(); // Prevent selecting when clicking clear

            const categoryLabel = name || 'Uncategorized';
            const questionsInCategory = questions.filter(q => q.category === name).length;

            if (questionsInCategory === 0) {
                showNotification(`No questions in "${categoryLabel}"`, 'info');
                return;
            }

            if (!confirm(`Delete all ${questionsInCategory} question${questionsInCategory !== 1 ? 's' : ''} from "${categoryLabel}"?`)) return;

            questions = questions.filter(q => q.category !== name);

            saveData();
            renderAll();
            showNotification(`Cleared ${questionsInCategory} question${questionsInCategory !== 1 ? 's' : ''} from "${categoryLabel}"`, 'success');
        }

        function updateCurrentCategoryBanner() {
            const nameEl = document.getElementById('current-category-name');
            nameEl.textContent = selectedCategory || 'Uncategorized';
        }

        // ===== QUESTIONS MANAGEMENT =====

        function addOrUpdateQuestion() {
            const text = document.getElementById('question-text').value.trim();
            const answer = parseFloat(document.getElementById('question-answer').value);

            if (!text) {
                showNotification('Please enter a question', 'error');
                return;
            }

            if (isNaN(answer)) {
                showNotification('Please enter a valid number for the answer', 'error');
                return;
            }

            if (editingQuestionId) {
                // Update existing question (keep its original category unless changed)
                const question = questions.find(q => q.id === editingQuestionId);
                if (question) {
                    question.text = text;
                    question.answer = answer;
                    // Keep category as-is when editing
                    showNotification('Question updated!', 'success');
                }
                cancelQuestionEdit();
            } else {
                // Add new question to selected category
                const newQuestion = {
                    id: Date.now().toString(),
                    text,
                    answer,
                    category: selectedCategory,
                    createdAt: Date.now(),
                    multiplier: 1,        // B value for scoring formula
                    avgPoints: 0,         // Running total of points for this question
                    avgCount: 0           // Number of times answered (resets after multiplier adjustment)
                };
                questions.push(newQuestion);
                showNotification(`Question added to "${selectedCategory || 'Uncategorized'}"!`, 'success');
            }

            clearQuestionForm();
            saveData();
            renderAll();
        }

        function editQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (!question) return;

            editingQuestionId = questionId;

            document.getElementById('question-text').value = question.text;
            document.getElementById('question-answer').value = question.answer;

            document.getElementById('question-form-title').textContent = 'Edit Question';
            document.getElementById('question-submit-btn').textContent = 'Update Question';
            document.getElementById('question-cancel-btn').style.display = 'inline-block';

            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelQuestionEdit() {
            editingQuestionId = null;
            clearQuestionForm();
            document.getElementById('question-form-title').textContent = 'Add New Question';
            document.getElementById('question-submit-btn').textContent = 'Add Question';
            document.getElementById('question-cancel-btn').style.display = 'none';
        }

        function clearQuestionForm() {
            document.getElementById('question-text').value = '';
            document.getElementById('question-answer').value = '';
        }

        function deleteQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (!question) return;

            if (!confirm('Delete this question?')) return;

            questions = questions.filter(q => q.id !== questionId);
            saveData();
            renderQuestions();
            showNotification('Question deleted', 'info');
        }

        // ===== TEST FUNCTIONALITY =====

        function getSelectedCategory() {
            const selected = document.querySelector('#category-checkboxes input[type="radio"]:checked');
            return selected ? selected.value : 'all';
        }

        function selectTestLength(length, element) {
            selectedTestLength = length;
            document.querySelectorAll('.test-length-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
        }

        function startTest() {
            const name = document.getElementById('player-name').value.trim();

            if (!name) {
                showNotification('Please enter your name', 'error');
                return;
            }

            const selectedCategory = getSelectedCategory();

            let availableQuestions;
            if (selectedCategory === 'all') {
                availableQuestions = [...questions];
            } else {
                availableQuestions = questions.filter(q => q.category === selectedCategory);
            }

            if (availableQuestions.length === 0) {
                showNotification('No questions available for this category!', 'error');
                return;
            }

            // Filter out questions that have already been asked (unless all have been asked)
            let unansweredQuestions = availableQuestions.filter(q => !askedQuestionIds.includes(q.id));

            // If all questions have been asked, reset the pool
            if (unansweredQuestions.length === 0) {
                askedQuestionIds = [];
                saveAskedQuestions();
                unansweredQuestions = availableQuestions;
                showNotification('All questions answered! Starting a new cycle.', 'info');
            }

            testState.playerName = name;
            testState.currentIndex = 0;
            testState.shuffledQuestions = shuffleArray(unansweredQuestions).slice(0, selectedTestLength);
            testState.answers = [];
            testState.totalScore = 0;
            testState.isActive = true;
            testState.selectedCategory = selectedCategory;

            document.getElementById('test-mode-selection').style.display = 'none';
            document.getElementById('test-intro').style.display = 'none';
            document.getElementById('test-question-container').style.display = 'block';
            document.getElementById('final-results').style.display = 'none';

            const catDisplay = testState.selectedCategory === 'all' ? 'All Questions' : testState.selectedCategory;
            document.getElementById('test-categories').textContent = `Category: ${catDisplay}`;

            displayCurrentQuestion();
        }

        function displayCurrentQuestion() {
            const question = testState.shuffledQuestions[testState.currentIndex];
            const total = testState.shuffledQuestions.length;

            document.getElementById('question-num').textContent = `Question ${testState.currentIndex + 1} of ${total}`;
            document.getElementById('running-total').textContent = testState.totalScore.toFixed(1);
            document.getElementById('current-question-text').textContent = question.text;
            document.getElementById('test-answer').value = '';
            document.getElementById('test-answer').focus();

            document.getElementById('submit-answer-btn').style.display = 'inline-block';
            document.getElementById('next-question-btn').style.display = 'none';
            document.getElementById('result-display').classList.remove('show');
            document.getElementById('test-answer').disabled = false;
        }

        function submitAnswer() {
            const answerInput = document.getElementById('test-answer');
            const userAnswer = parseFloat(answerInput.value);

            if (isNaN(userAnswer)) {
                showNotification('Please enter a number', 'error');
                return;
            }

            const question = testState.shuffledQuestions[testState.currentIndex];
            const correctAnswer = question.answer;
            const multiplier = question.multiplier || 1;
            const points = calculatePoints(userAnswer, correctAnswer, multiplier, question.text);

            // Mark this question as asked so it won't appear again until all questions are answered
            if (!askedQuestionIds.includes(question.id)) {
                askedQuestionIds.push(question.id);
                saveAskedQuestions();
            }

            // Update question's average tracking
            const originalQuestion = questions.find(q => q.id === question.id);
            if (originalQuestion) {
                originalQuestion.avgPoints = (originalQuestion.avgPoints || 0) + points;
                originalQuestion.avgCount = (originalQuestion.avgCount || 0) + 1;

                // Check if we need to adjust the multiplier (after 5 answers)
                if (originalQuestion.avgCount >= 5) {
                    adjustQuestionMultiplier(originalQuestion);
                }
            }

            // Update true average tracking
            trueAverageData.totalPoints += points;
            trueAverageData.totalAnswers++;
            saveTrueAverage();
            saveData();

            testState.answers.push({
                question: question.text,
                userAnswer,
                correctAnswer,
                points,
                multiplier
            });

            testState.totalScore += points;

            document.getElementById('correct-answer-value').textContent = formatNumber(correctAnswer);
            const pointsEl = document.getElementById('points-earned');
            pointsEl.textContent = `+${points.toFixed(1)} points`;
            pointsEl.className = 'points-earned';
            if (points >= 800) {
                pointsEl.classList.add('good');
            } else if (points >= 400) {
                pointsEl.classList.add('medium');
            } else {
                pointsEl.classList.add('bad');
            }

            document.getElementById('result-display').classList.add('show');
            document.getElementById('running-total').textContent = testState.totalScore.toFixed(1);

            document.getElementById('submit-answer-btn').style.display = 'none';
            document.getElementById('test-answer').disabled = true;

            if (testState.currentIndex < testState.shuffledQuestions.length - 1) {
                document.getElementById('next-question-btn').style.display = 'inline-block';
            } else {
                const nextBtn = document.getElementById('next-question-btn');
                nextBtn.textContent = 'See Results';
                nextBtn.style.display = 'inline-block';
            }
        }

        function calculatePoints(userAnswer, correctAnswer, multiplier = 1, questionText = '') {
            const B = multiplier || 1;

            // Check if this is a percentage question
            const isPercentageQuestion = questionText.toLowerCase().includes('percentage');

            if (isPercentageQuestion) {
                // Percentage formula: 100 * exp(-((x - P)^2) / (200 * B))
                // where x is user answer, P is correct answer, B is multiplier
                // Max score is 100 for percentage questions
                const x = userAnswer;
                const P = correctAnswer;
                const exponent = -((x - P) * (x - P)) / (200 * B);
                const points = 100 * Math.exp(exponent);
                return Math.round(points * 10) / 10;
            }

            // Standard formula: y = 1000 * exp(-(ln(x/U))^2 / B^2)
            // where x is user answer, U is correct answer, B is multiplier
            // Perfect answer = 1000 points, further away = fewer points
            // Higher B = more forgiving (easier), Lower B = stricter (harder)

            if (correctAnswer === 0) {
                // Handle edge case where correct answer is 0
                return userAnswer === 0 ? 1000 : 0;
            }

            if (userAnswer <= 0 && correctAnswer > 0) {
                // User gave non-positive answer for positive correct answer
                return 0;
            }

            if (userAnswer > 0 && correctAnswer < 0) {
                // User gave positive answer for negative correct answer
                return 0;
            }

            // Use absolute values for the ratio calculation
            const x = Math.abs(userAnswer);
            const U = Math.abs(correctAnswer);

            if (x === 0) return 0;

            const lnRatio = Math.log(x / U);
            const exponent = -(lnRatio * lnRatio) / (B * B);
            const points = 1000 * Math.exp(exponent);

            return Math.round(points * 10) / 10;
        }

        function nextQuestion() {
            testState.currentIndex++;

            if (testState.currentIndex >= testState.shuffledQuestions.length) {
                finishTest();
            } else {
                document.getElementById('next-question-btn').textContent = 'Next Question';
                displayCurrentQuestion();
            }
        }

        function finishTest() {
            testState.isActive = false;

            const newRecord = {
                id: Date.now().toString(),
                name: testState.playerName,
                score: Math.round(testState.totalScore * 10) / 10,
                questionsAnswered: testState.answers.length,
                category: testState.selectedCategory,
                date: new Date().toISOString()
            };
            records.push(newRecord);
            records.sort((a, b) => b.score - a.score); // Higher score is better
            records = records.slice(0, 100);
            saveData();

            document.getElementById('test-question-container').style.display = 'none';
            document.getElementById('final-results').style.display = 'block';
            document.getElementById('final-score').textContent = testState.totalScore.toFixed(1);

            const catDisplay = testState.selectedCategory === 'all' ? 'All Questions' : testState.selectedCategory;
            document.getElementById('final-categories').textContent = `Category: ${catDisplay}`;

            const breakdown = document.getElementById('score-breakdown');
            let breakdownHtml = '<h3>Question Breakdown</h3>';
            testState.answers.forEach((a, i) => {
                let pointsClass = 'good';
                if (a.points < 400) pointsClass = 'bad';
                else if (a.points < 800) pointsClass = 'medium';

                breakdownHtml += `
                    <div class="breakdown-item">
                        <span class="breakdown-question">${i + 1}. ${escapeHtml(a.question)}</span>
                        <span class="breakdown-points ${pointsClass}">+${a.points.toFixed(1)}</span>
                    </div>
                `;
            });
            breakdown.innerHTML = breakdownHtml;

            renderRecords();
        }

        function resetTest() {
            testState.isActive = false;
            // Show mode selection, hide everything else
            document.getElementById('test-mode-selection').style.display = 'block';
            document.getElementById('test-intro').style.display = 'none';
            document.getElementById('compare-intro').style.display = 'none';
            document.getElementById('test-question-container').style.display = 'none';
            document.getElementById('final-results').style.display = 'none';
            document.getElementById('compare-question-container').style.display = 'none';
            document.getElementById('compare-final-results').style.display = 'none';
            document.getElementById('player-name').value = '';
            document.getElementById('next-question-btn').textContent = 'Next Question';

            // Reset category selection to "All Questions"
            document.querySelectorAll('#category-checkboxes .category-checkbox').forEach(cb => {
                cb.classList.remove('selected');
                const input = cb.querySelector('input');
                if (input) input.checked = false;
            });
            const allQuestionsOption = document.querySelector('#category-checkboxes .category-checkbox');
            if (allQuestionsOption) {
                allQuestionsOption.classList.add('selected');
                const input = allQuestionsOption.querySelector('input');
                if (input) input.checked = true;
            }

            // Reset test length selection to default (20)
            selectedTestLength = 20;
            document.querySelectorAll('#test-intro .test-length-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.querySelector('.length-number').textContent === '20') {
                    opt.classList.add('selected');
                }
            });
        }

        function resetAllRecords() {
            if (records.length === 0) {
                showNotification('No records to reset', 'info');
                return;
            }

            if (!confirm(`Are you sure you want to delete all ${records.length} record${records.length !== 1 ? 's' : ''}? This cannot be undone.`)) return;

            records = [];
            saveData();
            renderRecords();
            updateCategorySelects();
            showNotification('All records have been reset', 'success');
        }

        // ===== RENDERING =====

        function renderAll() {
            renderCategoryCards();
            renderQuestions();
            renderCategoryCheckboxes();
            renderRecords();
            updateCategorySelects();
        }

        function renderCategoryCards() {
            const container = document.getElementById('category-cards');

            // Always show Uncategorized option
            const uncategorizedCount = questions.filter(q => !q.category).length;

            let html = `
                <div class="category-card ${selectedCategory === '' ? 'selected' : ''}" onclick="selectCategory('')">
                    <div class="cat-name">Uncategorized</div>
                    <div class="cat-count">${uncategorizedCount} question${uncategorizedCount !== 1 ? 's' : ''}</div>
                    <div class="cat-actions">
                        <button class="select-btn">${selectedCategory === '' ? 'Selected' : 'Select'}</button>
                        ${uncategorizedCount > 0 ? `<button class="clear-btn" onclick="clearCategoryQuestions('', event)">Clear All</button>` : ''}
                    </div>
                </div>
            `;

            if (categories.length === 0) {
                html += `
                    <div class="no-categories-message" style="grid-column: 1 / -1;">
                        <p>Create categories above to organize your questions!</p>
                    </div>
                `;
            } else {
                categories.forEach(cat => {
                    const count = questions.filter(q => q.category === cat).length;
                    const isSelected = selectedCategory === cat;
                    html += `
                        <div class="category-card ${isSelected ? 'selected' : ''}" onclick="selectCategory('${escapeHtml(cat)}')">
                            <div class="cat-name">${escapeHtml(cat)}</div>
                            <div class="cat-count">${count} question${count !== 1 ? 's' : ''}</div>
                            <div class="cat-actions">
                                <button class="select-btn">${isSelected ? 'Selected' : 'Select'}</button>
                                ${count > 0 ? `<button class="clear-btn" onclick="clearCategoryQuestions('${escapeHtml(cat)}', event)">Clear All</button>` : ''}
                                <button class="delete-btn" onclick="deleteCategory('${escapeHtml(cat)}', event)">Delete</button>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function updateCategorySelects() {
            // Update questions filter select
            const filterSelect = document.getElementById('questions-filter');
            const filterValue = filterSelect.value;
            filterSelect.innerHTML = '<option value="">All Categories</option>' +
                '<option value="__uncategorized__">Uncategorized</option>' +
                categories.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');
            filterSelect.value = filterValue;

            // Update records filter select with fixed categories
            const recordsFilter = document.getElementById('records-filter');
            const recordsValue = recordsFilter.value;
            recordsFilter.innerHTML = '<option value="">All Records</option>' +
                '<option value="all">All Questions</option>' +
                TEST_CATEGORIES.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');
            recordsFilter.value = recordsValue;
        }

        function renderCategoryCheckboxes() {
            const container = document.getElementById('category-checkboxes');

            // Start with "All Questions" selected by default
            let html = `
                <div class="category-checkbox selected" onclick="selectTestCategory(event, this)">
                    <input type="radio" name="test-category" value="all" style="display:none;" checked>
                    <span class="checkmark"></span>
                    <span class="cat-label">All Questions</span>
                    <span class="cat-count">(${questions.length})</span>
                </div>
            `;

            TEST_CATEGORIES.forEach(cat => {
                const count = questions.filter(q => q.category === cat).length;
                html += `
                    <div class="category-checkbox" onclick="selectTestCategory(event, this)">
                        <input type="radio" name="test-category" value="${escapeHtml(cat)}" style="display:none;">
                        <span class="checkmark"></span>
                        <span class="cat-label">${escapeHtml(cat)}</span>
                        <span class="cat-count">(${count})</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function selectTestCategory(event, element) {
            event.preventDefault();
            event.stopPropagation();

            // Deselect all options
            document.querySelectorAll('#category-checkboxes .category-checkbox').forEach(cb => {
                cb.classList.remove('selected');
                cb.querySelector('input').checked = false;
            });

            // Select the clicked option
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function renderQuestions() {
            const list = document.getElementById('questions-list');
            const count = document.getElementById('question-count');
            const filter = document.getElementById('questions-filter').value;
            const sortBy = document.getElementById('questions-sort').value;

            // Update true average display
            const trueAvg = getTrueAverage();
            const trueAvgEl = document.getElementById('true-avg-value');
            if (trueAverageData.totalAnswers > 0) {
                trueAvgEl.textContent = trueAvg.toFixed(1);
            } else {
                trueAvgEl.textContent = '--';
            }

            let filteredQuestions = [...questions];
            if (filter === '__uncategorized__') {
                filteredQuestions = filteredQuestions.filter(q => !q.category);
            } else if (filter) {
                filteredQuestions = filteredQuestions.filter(q => q.category === filter);
            }

            // Sort questions
            filteredQuestions.sort((a, b) => {
                const aAvg = a.avgCount > 0 ? a.avgPoints / a.avgCount : 0;
                const bAvg = b.avgCount > 0 ? b.avgPoints / b.avgCount : 0;
                const aReports = (a.reports || []).length;
                const bReports = (b.reports || []).length;

                switch (sortBy) {
                    case 'oldest':
                        return (a.createdAt || 0) - (b.createdAt || 0);
                    case 'newest':
                        return (b.createdAt || 0) - (a.createdAt || 0);
                    case 'multiplier-high':
                        return (b.multiplier || 1) - (a.multiplier || 1);
                    case 'multiplier-low':
                        return (a.multiplier || 1) - (b.multiplier || 1);
                    case 'avg-high':
                        return bAvg - aAvg;
                    case 'avg-low':
                        return aAvg - bAvg;
                    case 'reported':
                        return (bReports > 0 ? 1 : 0) - (aReports > 0 ? 1 : 0);
                    case 'most-reports':
                        return bReports - aReports;
                    default:
                        return (b.createdAt || 0) - (a.createdAt || 0);
                }
            });

            count.textContent = `${filteredQuestions.length} question${filteredQuestions.length !== 1 ? 's' : ''}${filter ? ' (filtered)' : ''}`;

            if (filteredQuestions.length === 0) {
                list.innerHTML = `
                    <div class="no-questions-message">
                        <h3>No questions ${filter ? 'in this category' : 'yet'}!</h3>
                        <p>${filter ? 'Try a different filter or add questions to this category.' : 'Add some questions above or import from a file.'}</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filteredQuestions.map(question => {
                const multiplier = question.multiplier || 1;
                const avgCount = question.avgCount || 0;
                const qAvg = avgCount > 0 ? (question.avgPoints / avgCount) : null;
                const reportCount = (question.reports || []).length;

                return `
                <li class="question-item">
                    <div class="question-header">
                        <span class="question-text">${escapeHtml(question.text)}</span>
                        <div class="question-actions">
                            <button class="edit-btn" onclick="editQuestion('${question.id}')" title="Edit">✎</button>
                            <button class="delete-btn" onclick="deleteQuestion('${question.id}')" title="Delete">✕</button>
                        </div>
                    </div>
                    <div class="question-meta">
                        <span class="question-answer">Answer: ${formatNumber(question.answer)}</span>
                        ${question.category ? `<span class="category-tag">${escapeHtml(question.category)}</span>` : '<span class="category-tag" style="background: rgba(136,136,136,0.3); color: #888;">Uncategorized</span>'}
                    </div>
                    <div class="question-stats">
                        <div class="question-multiplier">
                            <span class="mult-label">Multiplier (B):</span>
                            <input type="number" step="0.1" min="0.3" max="3" value="${multiplier}"
                                   onchange="updateQuestionMultiplier('${question.id}', this.value)"
                                   onclick="event.stopPropagation()" title="Higher = easier, Lower = harder">
                        </div>
                        <div class="question-avg">
                            <span class="avg-label">Avg:</span>
                            <span class="avg-value">${qAvg !== null ? qAvg.toFixed(1) : '--'}</span>
                            <span class="avg-count">(${avgCount}/5 answers)</span>
                        </div>
                        ${reportCount > 0 ? `
                        <div class="question-reported" onclick="viewQuestionReports('${question.id}', event)" title="View reports">
                            <span>⚠ ${reportCount} report${reportCount !== 1 ? 's' : ''}</span>
                            <button onclick="clearQuestionReports('${question.id}', event)" title="Clear reports" style="background: none; border: none; color: #ff9800; cursor: pointer; padding: 0 5px;">✕</button>
                        </div>
                        ` : ''}
                    </div>
                </li>
            `}).join('');
        }

        function renderRecords() {
            const list = document.getElementById('leaderboard');
            const filter = document.getElementById('records-filter').value;

            let filteredRecords = records;
            if (filter) {
                // Filter by single category (support both old categoryKey format and new category format)
                filteredRecords = records.filter(r => {
                    const recordCat = r.category || r.categoryKey || 'all';
                    return recordCat === filter;
                });
            }

            if (filteredRecords.length === 0) {
                list.innerHTML = `
                    <div class="no-records">
                        <h3>No records ${filter ? 'for this category' : 'yet'}!</h3>
                        <p>${filter ? 'Try a different filter or complete a test with this category.' : 'Complete a test to appear on the leaderboard.'}</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = filteredRecords.map((record, index) => {
                let rankClass = '';
                let itemClass = '';
                if (index === 0) { rankClass = 'gold'; itemClass = 'gold'; }
                else if (index === 1) { rankClass = 'silver'; itemClass = 'silver'; }
                else if (index === 2) { rankClass = 'bronze'; itemClass = 'bronze'; }

                const date = new Date(record.date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });

                // Support both old and new record formats
                let catDisplay;
                if (record.category) {
                    catDisplay = record.category === 'all' ? 'All Questions' : record.category;
                } else if (record.categories) {
                    catDisplay = record.categories.includes('all') ? 'All' : record.categories.join(', ');
                } else {
                    catDisplay = 'All Questions';
                }

                return `
                    <li class="leaderboard-item ${itemClass}">
                        <span class="rank ${rankClass}">#${index + 1}</span>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${escapeHtml(record.name)}</div>
                            <div class="leaderboard-meta">${record.questionsAnswered} questions</div>
                            <div class="leaderboard-categories">${escapeHtml(catDisplay)}</div>
                        </div>
                        <span class="leaderboard-score">${record.score.toFixed(1)}</span>
                    </li>
                `;
            }).join('');
        }

        // ===== MULTIPLIER ADJUSTMENT =====

        function adjustQuestionMultiplier(question) {
            const trueAverage = getTrueAverage();
            const questionAverage = question.avgPoints / question.avgCount;

            // Calculate how much to adjust based on difference from true average
            const difference = questionAverage - trueAverage;

            // Adjust multiplier proportionally to the difference
            // If question avg is higher than true avg, make it harder (decrease multiplier)
            // If question avg is lower than true avg, make it easier (increase multiplier)
            // Adjustment amount scales with the magnitude of the difference
            const adjustmentFactor = difference / 500; // Scale factor for adjustment
            const adjustment = -adjustmentFactor * 0.1; // Max ~0.2 adjustment per cycle

            // Apply adjustment with bounds (multiplier between 0.3 and 3)
            question.multiplier = Math.max(0.3, Math.min(3, (question.multiplier || 1) + adjustment));
            question.multiplier = Math.round(question.multiplier * 100) / 100; // Round to 2 decimals

            // Reset the question's average tracking for the next cycle
            question.avgPoints = 0;
            question.avgCount = 0;

            saveData();
        }

        function getTrueAverage() {
            if (trueAverageData.totalAnswers === 0) return 500; // Default if no data
            return trueAverageData.totalPoints / trueAverageData.totalAnswers;
        }

        function getQuestionAverage(question) {
            if (!question.avgCount || question.avgCount === 0) return null;
            return question.avgPoints / question.avgCount;
        }

        function updateQuestionMultiplier(questionId, newMultiplier) {
            const question = questions.find(q => q.id === questionId);
            if (!question) return;

            question.multiplier = Math.max(0.3, Math.min(3, parseFloat(newMultiplier) || 1));
            question.multiplier = Math.round(question.multiplier * 100) / 100;

            // Reset average tracking when manually editing
            question.avgPoints = 0;
            question.avgCount = 0;

            saveData();
            renderQuestions();
            showNotification(`Multiplier updated to ${question.multiplier}`, 'success');
        }

        // ===== UTILITY FUNCTIONS =====

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Check if leaving active test (estimation or compare)
            if (tabName !== 'test' && (testState.isActive || compareState.isActive)) {
                if (confirm('Leave the test? Your progress will be lost.')) {
                    if (testState.isActive) resetTest();
                    if (compareState.isActive) resetCompareTest();
                } else {
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.querySelector(`[onclick="switchTab('test')"]`).classList.add('active');
                    document.getElementById('test-tab').classList.add('active');
                    return;
                }
            }

            if (tabName === 'test') {
                renderCategoryCheckboxes();
                renderCompareCategoryCheckboxes();
            }

            if (tabName === 'records') {
                updateCompareRecordsFilter();
                renderCompareRecords();
            }
        }

        // Test mode selection
        let selectedTestMode = 'estimation';

        function selectTestMode(mode, element) {
            selectedTestMode = mode;
            document.querySelectorAll('.test-mode-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');

            // Show the appropriate intro
            document.getElementById('test-mode-selection').style.display = 'none';

            if (mode === 'estimation') {
                document.getElementById('test-intro').style.display = 'block';
                document.getElementById('compare-intro').style.display = 'none';
                renderCategoryCheckboxes();
            } else {
                document.getElementById('test-intro').style.display = 'none';
                document.getElementById('compare-intro').style.display = 'block';
                renderCompareCategoryCheckboxes();
            }
        }

        function backToModeSelection() {
            document.getElementById('test-mode-selection').style.display = 'block';
            document.getElementById('test-intro').style.display = 'none';
            document.getElementById('compare-intro').style.display = 'none';
        }

        // Records type switching
        function switchRecordsType(type) {
            document.querySelectorAll('.records-type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (type === 'estimation') {
                document.getElementById('estimation-records-section').style.display = 'block';
                document.getElementById('compare-records-section').style.display = 'none';
            } else {
                document.getElementById('estimation-records-section').style.display = 'none';
                document.getElementById('compare-records-section').style.display = 'block';
                renderCompareRecords();
            }
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function formatNumber(num) {
            if (Math.abs(num) >= 1000000) {
                return num.toLocaleString();
            }
            return num.toString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ===== DATA PERSISTENCE =====

        function saveData() {
            const data = {
                questions,
                categories,
                records,
                selectedCategory
            };
            localStorage.setItem('estimatorQuizData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('estimatorQuizData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    questions = data.questions || [];
                    categories = data.categories || [];
                    records = data.records || [];
                    selectedCategory = data.selectedCategory || '';

                    // Migration: ensure all questions have required fields
                    questions.forEach(q => {
                        if (q.category === undefined) q.category = '';
                        if (q.multiplier === undefined) q.multiplier = 1;
                        if (q.avgPoints === undefined) q.avgPoints = 0;
                        if (q.avgCount === undefined) q.avgCount = 0;
                    });

                    // Migration: ensure all records have categories field
                    records.forEach(r => {
                        if (!r.categories) r.categories = ['all'];
                        if (!r.categoryKey) r.categoryKey = r.categories.sort().join('|');
                    });
                } catch (e) {
                    console.error('Failed to load saved data');
                }
            }

            // Load asked questions tracking
            loadAskedQuestions();

            // Load true average tracking
            loadTrueAverage();
        }

        function saveTrueAverage() {
            localStorage.setItem('estimatorQuizTrueAverage', JSON.stringify(trueAverageData));
        }

        function loadTrueAverage() {
            const saved = localStorage.getItem('estimatorQuizTrueAverage');
            if (saved) {
                try {
                    trueAverageData = JSON.parse(saved);
                } catch (e) {
                    trueAverageData = { totalPoints: 0, totalAnswers: 0 };
                }
            }
        }

        function saveAskedQuestions() {
            localStorage.setItem('estimatorQuizAskedIds', JSON.stringify(askedQuestionIds));
        }

        function loadAskedQuestions() {
            const saved = localStorage.getItem('estimatorQuizAskedIds');
            if (saved) {
                try {
                    askedQuestionIds = JSON.parse(saved);
                    // Clean up: remove IDs for questions that no longer exist
                    const validIds = questions.map(q => q.id);
                    askedQuestionIds = askedQuestionIds.filter(id => validIds.includes(id));
                } catch (e) {
                    askedQuestionIds = [];
                }
            }
        }

        // ===== COMPARE TEST (WHICH IS BIGGER?) FUNCTIONS =====

        function selectCompareLength(length, element) {
            selectedCompareLength = length;
            document.querySelectorAll('#compare-intro .test-length-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function renderCompareCategoryCheckboxes() {
            const container = document.getElementById('compare-category-checkboxes');
            if (!container) return;

            let html = `
                <div class="category-checkbox selected" onclick="selectCompareCategory(event, this)">
                    <input type="radio" name="compare-category" value="all" checked>
                    <span>All Questions</span>
                </div>
            `;

            TEST_CATEGORIES.forEach(cat => {
                html += `
                    <div class="category-checkbox" onclick="selectCompareCategory(event, this)">
                        <input type="radio" name="compare-category" value="${cat}">
                        <span>${cat}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function selectCompareCategory(event, element) {
            event.preventDefault();
            event.stopPropagation();
            document.querySelectorAll('#compare-category-checkboxes .category-checkbox').forEach(cb => {
                cb.classList.remove('selected');
                cb.querySelector('input').checked = false;
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function getSelectedCompareCategory() {
            const selected = document.querySelector('#compare-category-checkboxes input[type="radio"]:checked');
            return selected ? selected.value : 'all';
        }

        function findMatchingQuestion(baseQuestion, availableQuestions) {
            // Find a question with answer BETWEEN +/- 50% and +/- 60% of base question's answer
            // This creates a "donut" range - different enough to be distinguishable
            // Example: for answer 1000, find questions with answers 400-500 OR 1500-1600
            const baseAnswer = baseQuestion.answer;

            // Inner bounds (50% difference)
            const innerMin = baseAnswer * 0.5;
            const innerMax = baseAnswer * 1.5;

            // Outer bounds (60% difference)
            const outerMin = baseAnswer * 0.4;
            const outerMax = baseAnswer * 1.6;

            // Filter questions in the "donut" range (between 50% and 60% different)
            const inRange = availableQuestions.filter(q => {
                if (q.id === baseQuestion.id) return false;
                const answer = q.answer;
                // Must be outside inner range (more than 50% different)
                // AND inside outer range (less than 60% different)
                const isInLowerDonut = answer >= outerMin && answer < innerMin;
                const isInUpperDonut = answer > innerMax && answer <= outerMax;
                return isInLowerDonut || isInUpperDonut;
            });

            if (inRange.length > 0) {
                // Randomly pick one from the donut range
                return inRange[Math.floor(Math.random() * inRange.length)];
            }

            // No questions in ideal range - find the nearest one that's at least 20% different
            let nearestQuestion = null;
            let nearestDiff = Infinity;
            const minDiff = baseAnswer * 0.2; // At least 20% different

            availableQuestions.forEach(q => {
                if (q.id !== baseQuestion.id) {
                    const diff = Math.abs(q.answer - baseAnswer);
                    if (diff >= minDiff && diff < nearestDiff) {
                        nearestDiff = diff;
                        nearestQuestion = q;
                    }
                }
            });

            // If still no match (all questions too similar), just pick any different question
            if (!nearestQuestion) {
                const different = availableQuestions.find(q => q.id !== baseQuestion.id && q.answer !== baseAnswer);
                return different || availableQuestions.find(q => q.id !== baseQuestion.id);
            }

            return nearestQuestion;
        }

        function generateQuestionPairs(questionsPool, count) {
            const pairs = [];
            const usedIds = new Set();
            const shuffled = [...questionsPool].sort(() => Math.random() - 0.5);

            for (let i = 0; i < count && shuffled.length > 0; i++) {
                // Pick a random base question that hasn't been used
                let baseQuestion = null;
                for (let j = 0; j < shuffled.length; j++) {
                    if (!usedIds.has(shuffled[j].id)) {
                        baseQuestion = shuffled[j];
                        break;
                    }
                }

                if (!baseQuestion) break;

                // Find available questions (not used yet)
                const availableForPairing = shuffled.filter(q => !usedIds.has(q.id) && q.id !== baseQuestion.id);

                if (availableForPairing.length === 0) break;

                const matchingQuestion = findMatchingQuestion(baseQuestion, availableForPairing);

                if (!matchingQuestion) break;

                // Mark both as used
                usedIds.add(baseQuestion.id);
                usedIds.add(matchingQuestion.id);

                // Randomly assign to A or B
                if (Math.random() < 0.5) {
                    pairs.push({ questionA: baseQuestion, questionB: matchingQuestion });
                } else {
                    pairs.push({ questionA: matchingQuestion, questionB: baseQuestion });
                }
            }

            return pairs;
        }

        function startCompareTest() {
            const playerName = document.getElementById('compare-player-name').value.trim();
            if (!playerName) {
                showNotification('Please enter your name', 'error');
                return;
            }

            const selectedCat = getSelectedCompareCategory();
            let availableQuestions = questions.filter(q => {
                if (selectedCat === 'all') return true;
                return q.category === selectedCat;
            });

            // Need at least 2 questions per pair, so we need at least 2 * count questions
            const neededQuestions = selectedCompareLength * 2;
            if (availableQuestions.length < 4) {
                showNotification('Not enough questions available. Need at least 4 questions.', 'error');
                return;
            }

            // Generate question pairs
            const pairs = generateQuestionPairs(availableQuestions, selectedCompareLength);

            if (pairs.length === 0) {
                showNotification('Could not generate question pairs.', 'error');
                return;
            }

            compareState = {
                playerName: playerName,
                currentIndex: 0,
                questionPairs: pairs,
                answers: [],
                correctCount: 0,
                isActive: true,
                selectedCategory: selectedCat
            };

            document.getElementById('test-mode-selection').style.display = 'none';
            document.getElementById('compare-intro').style.display = 'none';
            document.getElementById('compare-question-container').style.display = 'block';
            document.getElementById('compare-final-results').style.display = 'none';
            document.getElementById('compare-total-questions').textContent = pairs.length;

            // Update category display
            const catDisplay = document.getElementById('compare-test-categories');
            catDisplay.innerHTML = `<span class="category-tag">${selectedCat === 'all' ? 'All Categories' : selectedCat}</span>`;

            showCompareQuestion();
        }

        function showCompareQuestion() {
            const pair = compareState.questionPairs[compareState.currentIndex];

            document.getElementById('compare-question-num').textContent =
                `Question ${compareState.currentIndex + 1} of ${compareState.questionPairs.length}`;
            document.getElementById('compare-running-total').textContent = compareState.correctCount;

            document.getElementById('compare-text-a').textContent = pair.questionA.text;
            document.getElementById('compare-text-b').textContent = pair.questionB.text;

            // Reset option styles
            const optionA = document.getElementById('compare-option-a');
            const optionB = document.getElementById('compare-option-b');
            optionA.className = 'compare-option';
            optionB.className = 'compare-option';

            // Hide inline answers
            const answerA = document.getElementById('compare-answer-a');
            const answerB = document.getElementById('compare-answer-b');
            answerA.classList.remove('show');
            answerB.classList.remove('show');
            answerA.textContent = '';
            answerB.textContent = '';

            // Hide result section
            document.getElementById('compare-result').style.display = 'none';
        }

        function submitCompareAnswer(choice) {
            if (!compareState.isActive) return;

            const pair = compareState.questionPairs[compareState.currentIndex];
            const answerA = pair.questionA.answer;
            const answerB = pair.questionB.answer;

            // Determine which is actually bigger
            const correctChoice = answerA > answerB ? 'A' : (answerB > answerA ? 'B' : 'TIE');
            const isCorrect = (choice === correctChoice) || (correctChoice === 'TIE');

            if (isCorrect) {
                compareState.correctCount++;
            }

            // Store answer
            compareState.answers.push({
                questionA: pair.questionA.text,
                questionB: pair.questionB.text,
                answerA: answerA,
                answerB: answerB,
                userChoice: choice,
                correctChoice: correctChoice,
                correct: isCorrect
            });

            // Update UI
            const optionA = document.getElementById('compare-option-a');
            const optionB = document.getElementById('compare-option-b');

            optionA.classList.add('disabled');
            optionB.classList.add('disabled');

            if (correctChoice === 'A' || correctChoice === 'TIE') {
                optionA.classList.add('correct');
            }
            if (correctChoice === 'B' || correctChoice === 'TIE') {
                optionB.classList.add('correct');
            }

            if (choice === 'A' && correctChoice !== 'A' && correctChoice !== 'TIE') {
                optionA.classList.add('incorrect');
            }
            if (choice === 'B' && correctChoice !== 'B' && correctChoice !== 'TIE') {
                optionB.classList.add('incorrect');
            }

            // Show result
            const resultText = document.getElementById('compare-result-text');
            resultText.textContent = isCorrect ? 'Correct!' : 'Incorrect';
            resultText.className = 'compare-result-text ' + (isCorrect ? 'correct' : 'incorrect');

            // Show answers inline with questions
            const answerAEl = document.getElementById('compare-answer-a');
            const answerBEl = document.getElementById('compare-answer-b');
            answerAEl.textContent = 'Answer: ' + formatNumber(answerA);
            answerBEl.textContent = 'Answer: ' + formatNumber(answerB);
            answerAEl.classList.add('show');
            answerBEl.classList.add('show');

            document.getElementById('compare-running-total').textContent = compareState.correctCount;

            document.getElementById('compare-result').style.display = 'block';
        }

        function nextCompareQuestion() {
            compareState.currentIndex++;

            if (compareState.currentIndex >= compareState.questionPairs.length) {
                finishCompareTest();
            } else {
                showCompareQuestion();
            }
        }

        function finishCompareTest() {
            compareState.isActive = false;

            document.getElementById('compare-question-container').style.display = 'none';
            document.getElementById('compare-final-results').style.display = 'block';

            const total = compareState.questionPairs.length;
            const correct = compareState.correctCount;
            const percentage = Math.round((correct / total) * 100);

            document.getElementById('compare-final-score').textContent = `${correct} / ${total}`;
            document.getElementById('compare-percentage').textContent = `${percentage}%`;

            // Category display
            const catDisplay = document.getElementById('compare-final-categories');
            catDisplay.innerHTML = `<span class="category-tag">${compareState.selectedCategory === 'all' ? 'All Categories' : compareState.selectedCategory}</span>`;

            // Score breakdown
            const breakdown = document.getElementById('compare-score-breakdown');
            let breakdownHTML = '<h3>Question Breakdown</h3>';

            compareState.answers.forEach((answer, index) => {
                breakdownHTML += `
                    <div class="breakdown-item" style="background: rgba(${answer.correct ? '76, 175, 80' : '244, 67, 54'}, 0.1); border-left: 3px solid ${answer.correct ? '#4caf50' : '#f44336'};">
                        <div class="breakdown-question">Q${index + 1}: ${answer.correct ? 'Correct' : 'Incorrect'}</div>
                        <div style="font-size: 0.9em; color: #aaa; margin-top: 5px;">
                            <div>A: ${answer.questionA} = <strong>${formatNumber(answer.answerA)}</strong></div>
                            <div>B: ${answer.questionB} = <strong>${formatNumber(answer.answerB)}</strong></div>
                            <div style="margin-top: 5px;">You chose: ${answer.userChoice} | Correct: ${answer.correctChoice === 'TIE' ? 'Tie' : answer.correctChoice}</div>
                        </div>
                    </div>
                `;
            });

            breakdown.innerHTML = breakdownHTML;

            // Save record
            const record = {
                id: Date.now().toString(),
                name: compareState.playerName,
                correct: correct,
                total: total,
                percentage: percentage,
                category: compareState.selectedCategory,
                date: Date.now()
            };

            compareRecords.push(record);
            compareRecords.sort((a, b) => b.percentage - a.percentage || b.correct - a.correct);
            saveCompareRecords();
        }

        function resetCompareTest() {
            compareState = {
                playerName: '',
                currentIndex: 0,
                questionPairs: [],
                answers: [],
                correctCount: 0,
                isActive: false,
                selectedCategory: 'all'
            };

            // Show mode selection, hide everything else
            document.getElementById('test-mode-selection').style.display = 'block';
            document.getElementById('test-intro').style.display = 'none';
            document.getElementById('compare-intro').style.display = 'none';
            document.getElementById('test-question-container').style.display = 'none';
            document.getElementById('final-results').style.display = 'none';
            document.getElementById('compare-question-container').style.display = 'none';
            document.getElementById('compare-final-results').style.display = 'none';
            document.getElementById('compare-player-name').value = '';

            // Reset category selection to All
            document.querySelectorAll('#compare-category-checkboxes .category-checkbox').forEach(cb => {
                cb.classList.remove('selected');
                const input = cb.querySelector('input');
                if (input) input.checked = false;
            });
            const allOption = document.querySelector('#compare-category-checkboxes .category-checkbox');
            if (allOption) {
                allOption.classList.add('selected');
                const input = allOption.querySelector('input');
                if (input) input.checked = true;
            }

            // Reset test length selection to default (20)
            selectedCompareLength = 20;
            document.querySelectorAll('#compare-intro .test-length-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.querySelector('.length-number').textContent === '20') {
                    opt.classList.add('selected');
                }
            });
        }

        // Compare report modal
        let currentCompareReportQuestion = null;

        function openCompareReportModal(choice) {
            const pair = compareState.questionPairs[compareState.currentIndex];
            const question = choice === 'A' ? pair.questionA : pair.questionB;

            currentCompareReportQuestion = question;
            currentReportQuestionId = question.id;

            document.getElementById('report-question-text').textContent = question.text;
            document.querySelectorAll('.report-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('report-comment').value = '';
            document.getElementById('report-modal').classList.add('show');
        }

        // Compare Records Functions
        function saveCompareRecords() {
            localStorage.setItem('estimatorQuizCompareRecords', JSON.stringify(compareRecords));
        }

        function loadCompareRecords() {
            const saved = localStorage.getItem('estimatorQuizCompareRecords');
            if (saved) {
                try {
                    compareRecords = JSON.parse(saved);
                } catch (e) {
                    compareRecords = [];
                }
            }
        }

        function renderCompareRecords() {
            const container = document.getElementById('compare-leaderboard');
            const filterValue = document.getElementById('compare-records-filter').value;

            let filteredRecords = compareRecords;
            if (filterValue) {
                filteredRecords = compareRecords.filter(r => r.category === filterValue);
            }

            if (filteredRecords.length === 0) {
                container.innerHTML = '<li class="leaderboard-empty">No records yet. Be the first!</li>';
                return;
            }

            let html = '';
            filteredRecords.forEach((record, index) => {
                const categoryLabel = record.category === 'all' ? 'All Categories' : record.category;

                html += `
                    <li class="leaderboard-item ${index < 3 ? 'top-' + (index + 1) : ''}">
                        <span class="rank">#${index + 1}</span>
                        <div class="record-info">
                            <span class="name">${escapeHtml(record.name)}</span>
                            <span class="category-tag">${categoryLabel}</span>
                        </div>
                        <span class="score">${record.correct}/${record.total} (${record.percentage}%)</span>
                    </li>
                `;
            });

            container.innerHTML = html;
        }

        function updateCompareRecordsFilter() {
            const select = document.getElementById('compare-records-filter');
            if (!select) return;

            select.innerHTML = '<option value="">All Categories</option>';
            TEST_CATEGORIES.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            select.innerHTML += '<option value="all">All Questions (Mixed)</option>';
        }

        function resetCompareRecords() {
            if (!confirm('Are you sure you want to delete ALL "Which is Bigger?" records? This cannot be undone!')) {
                return;
            }
            compareRecords = [];
            saveCompareRecords();
            renderCompareRecords();
            showNotification('All compare records have been reset', 'success');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
